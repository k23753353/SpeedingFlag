<!-- deploy -->
<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <title>üö¶ FHE Speeding Check</title>
    <style>
      :root{
        /* Light poster palette */
        --paper:#F7F6F2; --paper-2:#FCFBF8; --ink:#0E1220; --muted:#5C6775; --line:#121822;
        --accent:#FF7A59; --accent-2:#1AC8FF; --ok:#14B26D; --bad:#E5484D;
        --card:#FFFFFF; --stroke:rgba(18,24,34,.12); --stroke-2:rgba(18,24,34,.08);
        --shadow:0 10px 30px rgba(18,24,34,.12), 0 2px 10px rgba(18,24,34,.06);
      }
      *{margin:0;padding:0;box-sizing:border-box}
      html,body{height:100%}
      body{
        font-family: "Space Grotesk", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
        color:var(--ink); background:var(--paper);
        background-image:
          radial-gradient(1200px 700px at -10% -10%, rgba(26,200,255,.12), transparent 60%),
          radial-gradient(900px 700px at 110% 20%, rgba(255,122,89,.10), transparent 55%),
          repeating-linear-gradient(120deg, transparent 0 42px, rgba(18,24,34,.03) 42px 84px);
        overflow-x:hidden;
      }
      /* Subtle paper grain */
      body::after{content:"";position:fixed;inset:0;pointer-events:none;opacity:.05;mix-blend-mode:multiply;background-image:url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"160\" height=\"160\" viewBox=\"0 0 160 160\"><filter id=\"n\"><feTurbulence baseFrequency=\"0.8\" numOctaves=\"2\" seed=\"3\"/></filter><rect width=\"100%\" height=\"100%\" filter=\"url(%23n)\" opacity=\"0.25\"/></svg>');}

      .wrap{max-width:1100px;margin:0 auto;padding:32px 18px 72px}
      header{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:26px}
      .brand{display:flex;align-items:center;gap:12px}
      .tag{padding:6px 10px;border-radius:999px;border:1.5px solid var(--line);background:linear-gradient(180deg,var(--paper-2),var(--paper));box-shadow:var(--shadow);color:var(--line);font-weight:800;font-size:12px;letter-spacing:.3px}
      h1{font-size:clamp(26px,4vw,40px);letter-spacing:.4px;font-weight:800}
      .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
      .btn{appearance:none;border:2px solid var(--line);cursor:pointer;padding:12px 18px;border-radius:14px;font-weight:800;letter-spacing:.3px;color:var(--ink);background:linear-gradient(180deg,#FFEDE6,#FFD6CB);box-shadow:0 6px 0 #CE5B41, var(--shadow);transition:transform .14s ease, box-shadow .14s ease}
      .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 0 #CE5B41, var(--shadow)}
      .btn:active:not(:disabled){transform:translateY(0);box-shadow:0 3px 0 #CE5B41, var(--shadow)}
      .btn:disabled{opacity:.55;cursor:not-allowed}
      .net-pill{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border-radius:999px;border:1.5px dashed var(--line);background:linear-gradient(180deg,var(--paper-2),var(--paper));color:var(--muted);font-weight:800}

      .grid{display:grid;grid-template-columns:1fr;gap:20px;margin-top:10px}
      @media (min-width:980px){.grid{grid-template-columns:1.15fr .85fr}}

      .card{position:relative;background:var(--card);border:2px solid var(--line);border-radius:22px;padding:20px 20px 22px;box-shadow:var(--shadow);overflow:hidden}
      .card::before{content:"FHE";position:absolute;top:-40px;right:-10px;transform:rotate(18deg);font-family:"DM Mono",monospace;color:rgba(18,24,34,.06);font-size:120px;letter-spacing:-4px;font-weight:700;pointer-events:none}
      .card h2{font-size:16px;font-weight:900;margin-bottom:12px;display:flex;align-items:center;gap:10px}
      .card h2 .dot{width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff,var(--accent-2) 60%,#0aa7d6 100%);box-shadow:0 0 18px rgba(26,200,255,.6)}

      .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
      @media (max-width:640px){.row{grid-template-columns:1fr}}
      .field label{display:block;color:var(--muted);font-size:12px;font-weight:800;margin:10px 0 6px;text-transform:uppercase}
      .field input[type="number"]{width:100%;padding:14px;border-radius:14px;border:2px solid var(--line);background:var(--paper-2);color:var(--ink);font-size:16px;outline:none;transition:box-shadow .18s ease, transform .18s ease}
      .field input[type="number"]:focus{box-shadow:0 0 0 4px rgba(26,200,255,.15), 0 3px 0 #0aa7d6;transform:translateY(-1px)}

      .switch{display:flex;gap:12px;align-items:center;margin:14px 0 6px}
      .toggle{position:relative;width:64px;height:36px;border-radius:999px;background:var(--paper-2);border:2px solid var(--line);cursor:pointer;box-shadow:inset 0 -2px 0 rgba(18,24,34,.08)}
      .toggle input{display:none}
      .thumb{position:absolute;top:2px;left:2px;width:30px;height:30px;border-radius:999px;background:conic-gradient(from 210deg,var(--accent-2),var(--accent));border:2px solid var(--line);transition:left .15s ease, box-shadow .15s ease;box-shadow:0 4px 0 rgba(18,24,34,.2)}
      .toggle input:checked + .thumb{left:32px}
      .hint{font-size:12px;color:var(--muted)}

      .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
      .a-btn{padding:12px 14px;border-radius:14px;border:2px solid var(--line);background:linear-gradient(180deg,#EAF8FF,#DDF0FF);color:var(--ink);font-weight:900;cursor:pointer;box-shadow:0 6px 0 #0b6fa1, var(--shadow);transition:transform .14s ease, box-shadow .14s ease}
      .a-btn.primary{background:linear-gradient(180deg,#FFE0D7,#FFD0C5);box-shadow:0 6px 0 #CE5B41, var(--shadow)}
      .a-btn:hover{transform:translateY(-2px)}
      .a-btn:active{transform:translateY(0);box-shadow:0 3px 0 rgba(18,24,34,.4), var(--shadow)}

      .status{margin-top:12px;padding:12px;border-radius:14px;border:2px dashed var(--line);background:var(--paper-2);color:var(--muted);font-weight:800}

      .result{margin-top:10px;padding:18px;border-radius:16px;border:2px solid var(--line);text-align:center;font-weight:900;font-size:18px;background:linear-gradient(180deg,#F4F7FA,#EEF3F8)}
      .result.ok{border-color:#0f7a4c;background:linear-gradient(180deg,#E8FFF3,#D9FFE9);color:var(--ok)}
      .result.bad{border-color:#b9363a;background:linear-gradient(180deg,#FFEAEA,#FFF3F3);color:var(--bad)}

      /* Poster-style gauge */
      .radar{position:relative;aspect-ratio:1/1;border-radius:22px;border:2px solid var(--line);background:
        radial-gradient(circle at 50% 60%, rgba(26,200,255,.16), transparent 62%),
        conic-gradient(from 210deg, rgba(20,178,109,.15) 0 140deg, rgba(229,72,77,.18) 140deg 180deg, rgba(20,178,109,.15) 180deg 360deg),
        var(--paper-2);
        overflow:hidden;box-shadow:var(--shadow)}
      .radar .grid{position:absolute;inset:0;opacity:.35;filter:contrast(120%)}
      .radar .needle{position:absolute;left:50%;bottom:50%;width:3px;height:42%;background:linear-gradient(180deg, var(--accent-2), var(--accent));transform-origin:bottom center;transform:translateX(-50%) rotate(-45deg);transition:transform .25s ease;border-radius:2px;box-shadow:0 0 0 2px var(--paper-2)}
      .radar .dot{position:absolute;left:50%;bottom:50%;width:12px;height:12px;transform:translate(-50%,50%);background:radial-gradient(circle,#fff,var(--accent-2));border:2px solid var(--line);border-radius:50%}
      .radar .label{position:absolute;bottom:12px;left:12px;color:var(--ink);font-weight:900;background:var(--paper-2);border:2px solid var(--line);border-radius:12px;padding:6px 10px;box-shadow:var(--shadow)}

      .loading{position:relative}
      .loading::after{content:"";position:absolute;right:12px;top:50%;transform:translateY(-50%);width:18px;height:18px;border-radius:50%;border:3px solid rgba(18,24,34,.25);border-top-color:var(--ink);animation:spin 1s linear infinite}
      @keyframes spin{to{transform:translateY(-50%) rotate(1turn)}}
    </style>
    <style>
      /* Speedometer-specific overrides (horizontal gauge) */
      #hg { width:100%; height:auto; display:block; }
      #hgNeedle { stroke: var(--line); stroke-width:3.5; stroke-linecap:round; filter:url(#shadow); }
      #hgLimit { stroke: var(--bad); stroke-width:4; stroke-linecap:round; }
      #hgLimit.glow { filter: drop-shadow(0 0 4px rgba(229,72,77,.8)) drop-shadow(0 0 12px rgba(229,72,77,.6)); animation: throb 1s ease-in-out infinite; }
      #hgLimitArea { fill: var(--bad); opacity:.15; }
      #hgBarBg { fill: #E9EEF5; stroke: var(--line); stroke-width:2; }
      #hgBarFill { fill: url(#gFill); }
      .g-info { display:flex; gap:10px; align-items:center; margin-top:12px; flex-wrap:wrap; }
      .chip { padding:8px 10px; border-radius:999px; border:2px solid var(--line); background: var(--paper-2); font-weight:900; }
      .chip.red { border-color:#b9363a; background: linear-gradient(180deg,#FFEAEA,#FFF3F3); color: var(--bad); }
      .tick { stroke: var(--line); }
      .tick.major { stroke-width:2.2; opacity:.9 }
      .tick.minor { stroke-width:1.2; opacity:.5 }
      .tlabel { font-size:10px; font-weight:800; fill: var(--ink); }
      @keyframes throb { 0%,100%{opacity:1} 50%{opacity:.66} }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="brand">
          <span class="tag">ZAMA FHEVM</span>
          <h1>FHE Speeding Check</h1>
        </div>
        <div class="right">
          <span id="netPill" class="net-pill">Network: <b>Sepolia</b></span>
          <button id="connect" class="btn">üîó Connect Wallet</button>
        </div>
      </header>

      <section class="grid">
        <!-- Left: inputs + actions -->
        <div class="card">
          <h2><span class="dot"></span> Encrypted Inputs</h2>
          <div class="row">
            <div class="field">
              <label>Speed (integer)</label>
              <input id="speed" type="number" min="0" max="65535" placeholder="e.g., 97" disabled />
            </div>
            <div class="field">
              <label>Limit (integer)</label>
              <input id="limit" type="number" min="0" max="65535" placeholder="e.g., 90" disabled />
            </div>
          </div>

          <div class="switch" title="If ON, anyone can decrypt the result via publicDecrypt; otherwise only you via userDecrypt.">
            <label class="toggle">
              <input id="togglePublic" type="checkbox" />
              <span class="thumb"></span>
            </label>
            <div>
              <div style="font-weight:900">Publish result</div>
              <div class="hint">Global decrypt (public flag) vs private (caller only)</div>
            </div>
          </div>

          <div class="actions">
            <button id="btnCheck" class="a-btn primary" disabled>‚ö° Check Speed</button>
            <button id="btnLast" class="a-btn" disabled>üîé Last Result (from event)</button>
          </div>

          <div id="status" class="status">Waiting for connection‚Ä¶</div>
          <div id="result" class="result" style="display:none">‚Äì</div>
        </div>

        <!-- Right: live radar speedometer / status -->
        <div class="card">
          <h2><span class="dot"></span> Visual Gauge</h2>
          <div id="radar" class="radar">
            <svg id="hg" viewBox="0 0 420 120" aria-hidden="true">
              <defs>
                <linearGradient id="gFill" x1="0%" x2="100%">
                  <stop offset="0%" stop-color="#EAF8FF"/>
                  <stop offset="100%" stop-color="#DDF0FF"/>
                </linearGradient>
                <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                  <feDropShadow dx="0" dy="2" stdDeviation="1.2" flood-color="rgba(18,24,34,.35)"/>
                </filter>
              </defs>
              <!-- base bar -->
              <rect id="hgBarBg" x="20" y="60" rx="7" ry="7" width="380" height="14" />
              <rect id="hgBarFill" x="20" y="60" rx="7" ry="7" width="0" height="14" />
              <!-- ticks & labels -->
              <g id="hgTicks"></g>
              <!-- red area from limit to max -->
              <rect id="hgLimitArea" x="20" y="60" width="0" height="14"/>
              <!-- markers -->
              <line id="hgLimit" x1="20" y1="45" x2="20" y2="95" />
              <line id="hgNeedle" x1="20" y1="40" x2="20" y2="100" />
            </svg>
            <div class="label">Status: <span id="label">‚Äì</span></div>
            <div class="g-info">
              <div class="chip">Speed: <b id="speedVal">0</b></div>
              <div class="chip red">Limit: <b id="limitVal">0</b></div>
            </div>
          </div>
            <div class="g-info">
              <div class="chip">Speed: <b id="speedVal">0</b></div>
              <div class="chip red">Limit: <b id="limitVal">0</b></div>
            </div>
          </div>
            <div class="dot"></div>
            <div class="label">Status: <span id="label">‚Äì</span></div>
          </div>
        </div>
      </section>
    </div>

    <!-- Official Zama Relayer SDK -->
    <script type="module" crossorigin src="https://cdn.zama.ai/relayer-sdk-js/0.1.2/relayer-sdk-js.js"></script>
    <!-- ethers v6 -->
    <script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm"></script>

    <script type="module">
      import { BrowserProvider, Contract, getAddress } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";
      import { initSDK, createInstance, SepoliaConfig, generateKeypair } from "https://cdn.zama.ai/relayer-sdk-js/0.1.2/relayer-sdk-js.js";

      // ===== Console logger (scoped) =====
      let __uiLog = 0; const clog = (tag, payload) => console.log(`[UI/${++__uiLog}] ${tag}`, payload ?? "");

      // ===== DOM refs =====
      const $ = (id) => document.getElementById(id);
      const connectBtn = $("connect");
      const speedIn = $("speed");
      const limitIn = $("limit");
      const togglePublic = $("togglePublic");
      const btnCheck = $("btnCheck");
      const btnLast = $("btnLast");
      const statusEl = $("status");
      const resultEl = $("result");
      const label = $("label");
      const speedVal = $("speedVal");
      const limitVal = $("limitVal");
      // Horizontal gauge refs
      const hg = $("hg");
      const hgTicks = $("hgTicks");
      const hgNeedle = $("hgNeedle");
      const hgLimit = $("hgLimit");
      const hgLimitArea = $("hgLimitArea");
      const hgBarFill = $("hgBarFill");

      // ===== Config =====
      const SEPOLIA_HEX = "0xaa36a7"; // 11155111
      const SEPOLIA_ID = 11155111n;
      const CONTRACT_ADDRESS = "0x23Ffbaf9AcF0808E74Ecc75DdCBc151f073f1c43";
      const KMS_ADDRESS = "0x1364cBBf2cDF5032C47d8226a6f6FBD2AFCDacAC";
      const RELAYER_URL = "https://relayer.testnet.zama.cloud";
      const GATEWAY_URL = "https://gateway.sepolia.zama.ai/";

      // ABI (unchanged logic)
      const abi = [
        { inputs:[{name:"speedExt",type:"bytes32"},{name:"limitExt",type:"bytes32"},{name:"proof",type:"bytes"}], name:"checkSpeed", outputs:[{name:"overCt",type:"bytes32"}], stateMutability:"nonpayable", type:"function" },
        { inputs:[{name:"speedExt",type:"bytes32"},{name:"limitExt",type:"bytes32"},{name:"proof",type:"bytes"}], name:"checkSpeedPublic", outputs:[{name:"overCt",type:"bytes32"}], stateMutability:"nonpayable", type:"function" },
        { anonymous:false, inputs:[{indexed:true,name:"user",type:"address"},{indexed:false,name:"resultHandle",type:"bytes32"},{indexed:false,name:"isPublic",type:"bool"}], name:"SpeedChecked", type:"event" },
      ];

      // ===== State =====
      let provider, signer, user, relayer, contract; let lastHandle = null;
      const setStatus = (t) => { statusEl.textContent = t; };
      const setResult = (flag /* boolean|null */) => {
        resultEl.style.display = "block"; resultEl.classList.remove("ok","bad");
        if (flag === null) { resultEl.textContent = "‚Äì"; label.textContent = "‚Äì"; updateGauge(null); return; }
        const ok = !flag; // flag = overspeed
        if (ok) { resultEl.classList.add("ok"); resultEl.textContent = "‚úÖ Within limit"; label.textContent = "OK"; }
        else { resultEl.classList.add("bad"); resultEl.textContent = "üö® Over the limit"; label.textContent = "OVER"; }
        updateGauge(flag); clog('setResult', { flag, text: resultEl.textContent });
      };

      // ===== Horizontal gauge helpers =====
      const START_X = 20; const END_X = 400; const BAR_W = END_X - START_X;
      let currentScaleMax = 200;
      const SCALE_STEPS = [60,80,100,120,140,160,180,200,220,240,260,300];
      const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
      const v2x = (v,max)=> START_X + (clamp(v,0,max)/max) * BAR_W;

      function getScaleMax(){
        const s = clamp(parseInt(speedIn.value||"0"), 0, 65535);
        const l = clamp(parseInt(limitIn.value||"0"), 0, 65535);
        const need = Math.max(s,l,100);
        for (const v of SCALE_STEPS) if (need <= v) return v;
        return Math.min(65535, Math.ceil(need/20)*20);
      }

      function drawHScale(max){
        hgTicks.innerHTML = "";
        const yTop = 56, yMid = 60, yBot = 74, yLbl = 50;
        const minorStep = 10; let tCount = 0;
        for (let v=0; v<=max; v+=minorStep){
          const major = v % 20 === 0; const x = v2x(v,max);
          const line = document.createElementNS('http://www.w3.org/2000/svg','line');
          line.setAttribute('x1', x); line.setAttribute('x2', x);
          line.setAttribute('y1', major? yTop : yMid); line.setAttribute('y2', yBot);
          line.setAttribute('class', `tick ${major? 'major':'minor'}`);
          hgTicks.appendChild(line);
          if (major){
            const text = document.createElementNS('http://www.w3.org/2000/svg','text');
            text.setAttribute('x', x); text.setAttribute('y', yLbl);
            text.setAttribute('text-anchor','middle'); text.setAttribute('class','tlabel');
            text.textContent = String(v); hgTicks.appendChild(text);
          }
          tCount++;
        }
        clog('drawHScale(max)', { max, ticks:tCount });
      }

      function updateGauge(flag){
        const s = clamp(parseInt(speedIn.value||"0"),0,65535);
        const l = clamp(parseInt(limitIn.value||"0"),0,65535);
        const max = getScaleMax(); if (max !== currentScaleMax){ currentScaleMax = max; drawHScale(max); }
        speedVal.textContent = String(s); limitVal.textContent = String(l);
        const xs = v2x(s, max), xl = v2x(l, max);
        hgNeedle.setAttribute('x1', xs); hgNeedle.setAttribute('x2', xs);
        hgLimit.setAttribute('x1', xl); hgLimit.setAttribute('x2', xl);
        const fillW = Math.max(0, xs - START_X); hgBarFill.setAttribute('width', fillW);
        hgLimitArea.setAttribute('x', xl); hgLimitArea.setAttribute('width', Math.max(0, END_X - xl));
        const over = (s >= l && l>0); if (over) hgLimit.classList.add('glow'); else hgLimit.classList.remove('glow');
        clog('updateGauge', { speed:s, limit:l, max, xs, xl, over, flag });
      }

      speedIn.addEventListener('input', () => updateGauge(null));
      limitIn.addEventListener('input', () => updateGauge(null));
      drawHScale(currentScaleMax); updateGauge(null);

      // ===== Network guards =====
      if (window.ethereum?.on) {
        window.ethereum.on('chainChanged', () => window.location.reload());
        window.ethereum.on('accountsChanged', () => window.location.reload());
      }
      async function ensureSepolia(){
        const cid = await window.ethereum.request({ method:"eth_chainId" });
        if (BigInt(cid) !== SEPOLIA_ID) {
          try { await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: SEPOLIA_HEX }] }); }
          catch (err) {
            if (err?.code === 4902) {
              await window.ethereum.request({ method:"wallet_addEthereumChain", params:[{ chainId: SEPOLIA_HEX, chainName:"Sepolia", nativeCurrency:{ name:"SepoliaETH", symbol:"SEP", decimals:18 }, rpcUrls:["https://sepolia.infura.io/v3/"], blockExplorerUrls:["https://sepolia.etherscan.io"] }] });
            } else { throw err; }
          }
        }
      }

      // ===== Connect flow =====
      connectBtn.addEventListener('click', async () => {
        connectBtn.classList.add('loading'); clog('connect.click', { togglePublic: togglePublic.checked });
        try {
          if (!window.ethereum) throw new Error('MetaMask not found');
          await ensureSepolia(); provider = new BrowserProvider(window.ethereum);
          await provider.send('eth_requestAccounts', []); signer = await provider.getSigner(); user = await signer.getAddress();
          const net = await provider.getNetwork(); clog('connected', { user, chainId: String(net.chainId) });
          if (net.chainId !== SEPOLIA_ID) throw new Error('Please switch to Sepolia');

          await initSDK(); const relayerCfg = { ...SepoliaConfig, network: window.ethereum, relayerUrl: RELAYER_URL, gatewayUrl: GATEWAY_URL, debug: true };
          const kmsCode = await provider.getCode(KMS_ADDRESS); const ctrCode = await provider.getCode(CONTRACT_ADDRESS);
          clog('codeCheck', { kmsLen: kmsCode.length, ctrLen: ctrCode.length });
          relayer = await createInstance(relayerCfg);

          contract = new Contract(CONTRACT_ADDRESS, abi, signer);
          contract.on('SpeedChecked', (who, handle, isPublic) => {
            clog('event.SpeedChecked', { who, handle, isPublic });
            if (String(who).toLowerCase() === String(user).toLowerCase()) { lastHandle = handle; setStatus(`‚úÖ Result ready (${isPublic ? 'public' : 'private'})`); }
          });

          connectBtn.textContent = `üîó Connected ¬∑ ${user.slice(0,6)}‚Ä¶${user.slice(-4)}`; connectBtn.disabled = true;
          [speedIn, limitIn, btnCheck, btnLast].forEach(el => el.disabled = false);
          setStatus(`Connected as ${user.slice(0,6)}‚Ä¶${user.slice(-4)}`);
        } catch (e) { console.error(e); setStatus(`‚ùå ${e.message}`); clog('connect.error', e.message); }
        finally { connectBtn.classList.remove('loading'); }
      });

      // ===== Encrypt + send =====
      btnCheck.addEventListener('click', async () => {
        try {
          if (!signer || !relayer || !contract) throw new Error('Connect wallet first');
          const s = parseInt(speedIn.value); const l = parseInt(limitIn.value);
          clog('btnCheck.inputs', { speed:s, limit:l, public: togglePublic.checked });
          if (!Number.isFinite(s) || s < 0 || s > 65535) throw new Error('Speed must be 0..65535');
          if (!Number.isFinite(l) || l < 0 || l > 65535) throw new Error('Limit must be 0..65535');

          btnCheck.classList.add('loading'); setResult(null); setStatus('üîê Encrypting & sending‚Ä¶');
          const buf = relayer.createEncryptedInput(getAddress(CONTRACT_ADDRESS), getAddress(user));
          if (typeof buf.add16 !== 'function') throw new Error('SDK add16 not available (update SDK)');
          buf.add16(s); buf.add16(l); clog('encrypt.add16','done');
          const { handles, inputProof } = await buf.encrypt(); clog('encrypt.done', { h0: String(handles[0]).slice(0,10)+'‚Ä¶', h1: String(handles[1]).slice(0,10)+'‚Ä¶', proofLen: inputProof?.length });

          const pub = togglePublic.checked; const fn = pub ? contract.checkSpeedPublic : contract.checkSpeed;
          const tx = await fn(handles[0], handles[1], inputProof, { gasLimit: 3_000_000 }); clog('tx.sent', { hash: tx.hash });
          await tx.wait(); const receipt = await provider.getTransactionReceipt(tx.hash); clog('tx.receipt', { status: receipt.status, logs: receipt.logs?.length });

          let handle = null, isPublic = pub;
          for (const lg of receipt.logs) {
            try { const parsed = contract.interface.parseLog(lg); if (parsed && parsed.name === 'SpeedChecked') { handle = parsed.args.resultHandle; isPublic = parsed.args.isPublic; break; } } catch {}
          }
          if (!handle) throw new Error('Result handle not found in logs'); lastHandle = handle; clog('handle', String(handle));

          let over = false;
          if (isPublic) {
            const out = await relayer.publicDecrypt([handle]); const v = Array.isArray(out) ? out[0] : (out[handle] ?? out[String(handle)]);
            over = (typeof v === 'bigint') ? (v === 1n) : (Number(v) === 1); clog('decrypt.public', { value: String(v), over });
          } else {
            const kp = await generateKeypair(); const startTs = Math.floor(Date.now()/1000).toString(); const days = '7';
            const eip712 = relayer.createEIP712(kp.publicKey, [CONTRACT_ADDRESS], startTs, days);
            const sig = await signer.signTypedData(eip712.domain, { UserDecryptRequestVerification: eip712.types.UserDecryptRequestVerification }, eip712.message);
            const pairs = [{ handle, contractAddress: CONTRACT_ADDRESS }];
            const out = await relayer.userDecrypt(pairs, kp.privateKey, kp.publicKey, sig.replace('0x',''), [CONTRACT_ADDRESS], user, startTs, days);
            const v = out[handle] ?? out[String(handle)]; over = (typeof v === 'bigint') ? (v === 1n) : (Number(v) === 1); clog('decrypt.user', { value: String(v), over });
          }

          setResult(over); setStatus('‚úÖ Done');
        } catch (e) { console.error(e); setStatus(`‚ùå ${e.message}`); clog('btnCheck.error', e.message); }
        finally { btnCheck.classList.remove('loading'); }
      });

      // ===== Re-show last =====
      btnLast.addEventListener('click', async () => {
        try {
          if (!lastHandle) throw new Error('No handle yet ‚Äî run a check first');
          setStatus('üîì Decrypting last result‚Ä¶'); clog('btnLast.handle', String(lastHandle));
          const out = await relayer.publicDecrypt([lastHandle]); const v = Array.isArray(out) ? out[0] : (out[lastHandle] ?? out[String(lastHandle)]);
          const isNum = (typeof v === 'bigint') ? Number(v) : Number(v); if (Number.isNaN(isNum)) throw new Error('Failed to decrypt last result');
          clog('btnLast.decrypt', { value: String(v), asNumber: isNum }); setResult(isNum === 1); setStatus('‚úÖ Last result ready');
        } catch (e) { console.error(e); setStatus(`‚ùå ${e.message}`); clog('btnLast.error', e.message); }
      });
    </script>
  </body>
</html>
